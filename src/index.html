<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Claire's Chore Quest - A gamified task manager for kids">
  <title>Claire's Chore Quest</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comfortaa:wght@400;700&family=Kalam:wght@400;700&family=Nunito:wght@400;700;900&family=Comic+Neue:wght@400;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }
    .animate-slideDown {
      animation: slideDown 0.3s ease-out;
    }
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    .emoji-button {
      font-size: 2rem;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(255, 255, 255, 0.3);
    }
    .emoji-button:hover {
      transform: scale(1.2);
      background: rgba(255, 255, 255, 0.6);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useReducer, useRef, createContext, useContext } = React;

    // Icon Components
    const Icons = {
      Star: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
        </svg>
      ),
      Sparkles: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
        </svg>
      ),
      Home: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
        </svg>
      ),
      Settings: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="3" />
          <path d="M12 1v6m0 6v6m6-12h-6m-6 0H0m18 6h-6m-6 0H0" />
        </svg>
      ),
      Trophy: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
          <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
          <path d="M4 22h16" />
          <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
        </svg>
      ),
      Gift: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="3" y="8" width="18" height="4" rx="1" />
          <path d="M12 8v13" />
          <path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" />
        </svg>
      ),
      Play: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polygon points="6 3 20 12 6 21 6 3" />
        </svg>
      ),
      Pause: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="6" y="4" width="4" height="16" />
          <rect x="14" y="4" width="4" height="16" />
        </svg>
      ),
      RotateCcw: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
          <path d="M3 3v5h5" />
        </svg>
      ),
      Check: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M20 6 9 17l-5-5" />
        </svg>
      ),
      Plus: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M5 12h14" />
          <path d="M12 5v14" />
        </svg>
      ),
      X: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M18 6 6 18" />
          <path d="m6 6 12 12" />
        </svg>
      ),
      Menu: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="4" x2="20" y1="12" y2="12" />
          <line x1="4" x2="20" y1="6" y2="6" />
          <line x1="4" x2="20" y1="18" y2="18" />
        </svg>
      ),
      Search: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.3-4.3" />
        </svg>
      ),
      Clock: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
      ),
      Target: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="10" />
          <circle cx="12" cy="12" r="6" />
          <circle cx="12" cy="12" r="2" />
        </svg>
      ),
      Award: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="8" r="6" />
          <path d="m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526" />
        </svg>
      ),
      Zap: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z" />
        </svg>
      ),
      Crown: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z" />
          <path d="M5 21h14" />
        </svg>
      ),
      ChevronRight: (props) => (
        <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="m9 18 6-6-6-6" />
        </svg>
      )
    };

    // Emoji Library
    const EMOJI_LIBRARY = {
      activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ', 'üèê', 'üèâ', 'üé±', 'üèì', 'üè∏', 'üèí', 'ü•ä', 'ü•ã', '‚õ≥', '‚õ∏Ô∏è', 'üé£', 'üéΩ', 'üéø', 'üõ∑'],
      school: ['üìö', 'üìñ', '‚úèÔ∏è', '‚úçÔ∏è', 'üìù', 'üìê', 'üìè', 'üî¨', 'üî≠', 'üß™', 'üéí', 'üñäÔ∏è', 'üñçÔ∏è', '‚úÇÔ∏è', 'üìå', 'üìç', 'üìé', 'üìã'],
      home: ['üè†', 'üè°', 'üõèÔ∏è', 'üõãÔ∏è', 'üö™', 'üßπ', 'üß∫', 'üßª', 'üßº', 'üßΩ', 'üóëÔ∏è', 'üí°', 'üïØÔ∏è'],
      nature: ['üå±', 'üåø', 'üçÄ', 'üåæ', 'üåµ', 'üå≤', 'üå≥', 'üå¥', 'üåª', 'üå∫', 'üå∏', 'üåº', 'üå∑', 'üåπ', 'üçÅ', 'üçÇ', 'üçÉ'],
      food: ['üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'ü•ë', 'üçÜ', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü•ï', 'ü•î', 'üç†', 'ü•ê', 'ü•ñ', 'üßÄ', 'ü•ö', 'üç≥', 'ü•û', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü•™', 'üåÆ', 'üåØ', 'ü•ó', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'üç§', 'üçô', 'üçö', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üç∞', 'üéÇ', 'üßÅ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', 'üçØ'],
      animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë', 'üêê', 'ü¶å', 'üêï', 'üê©', 'üêà', 'üêì', 'ü¶É', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'üïäÔ∏è', 'üêá', 'ü¶ù', 'ü¶®', 'ü¶°', 'ü¶¶', 'üêÅ', 'üêÄ', 'üêøÔ∏è', 'ü¶î'],
      symbols: ['‚≠ê', '‚ú®', 'üåü', 'üí´', '‚ö°', 'üî•', 'üí•', 'üí¢', 'üí¨', 'üí≠', 'üí§', 'üí®', 'üí¶', 'üíß', 'üíî', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü'],
      celebrations: ['üéâ', 'üéä', 'üéà', 'üéÅ', 'üéÄ', 'üéÇ', 'üéÑ', 'üéÉ', 'üéÜ', 'üéá', 'üß®', '‚ú®'],
      sports: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'üèì', 'üè∏', 'üèí', 'ü•ç', 'üèè', '‚õ≥', 'üèπ', 'üé£', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõº', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', 'üèÇ', 'üèãÔ∏è', 'üßó', 'üö¥', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ'],
      time: ['‚è∞', '‚è±Ô∏è', '‚è≤Ô∏è', '‚è≥', '‚åõ'],
      transportation: ['üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ', 'üöú', 'üõ¥', 'üö≤', 'üõµ', 'üèçÔ∏è', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üöÅ', 'üöÄ', 'üõ∏', 'üö¢', '‚õµ', 'üõ∂'],
      tools: ['üî®', '‚õèÔ∏è', '‚öíÔ∏è', 'üõ†Ô∏è', 'üîß', 'üî©', '‚öôÔ∏è', 'üóúÔ∏è', '‚öñÔ∏è'],
      music: ['üéµ', 'üé∂', 'üéº', 'üéπ', 'ü•Å', 'üé∑', 'üé∫', 'üé∏', 'üéª', 'üé§', 'üéß', 'üìª'],
      tech: ['üíª', 'üñ•Ô∏è', 'üñ®Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üì±', 'üì≤', '‚òéÔ∏è', 'üìû', 'üì∫', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üîã', 'üîå', 'üí°', 'üî¶'],
      misc: ['üé®', 'üñåÔ∏è', 'üñçÔ∏è', 'üé≠', 'üé™', 'üé¨', 'üéÆ', 'üé∞', 'üß©', 'üéØ', 'üé≤']
    };

    const ALL_EMOJIS = Object.values(EMOJI_LIBRARY).flat();

    // Themes
    const THEMES = {
      space: {
        id: 'space',
        name: 'Space Adventure',
        fontFamily: "'Orbitron', sans-serif",
        colors: {
          primary: 'from-indigo-600 via-purple-600 to-pink-600',
          bg: 'bg-gradient-to-br from-slate-900 via-purple-900 to-indigo-900',
          card: 'bg-gradient-to-br from-slate-800/80 to-purple-800/80',
          accent: 'bg-indigo-500',
          text: 'text-white',
          textLight: 'text-purple-200'
        }
      },
      sunset: {
        id: 'sunset',
        name: 'Sunset Adventure',
        fontFamily: "'Fredoka One', cursive",
        colors: {
          primary: 'from-orange-400 via-pink-400 to-purple-500',
          bg: 'bg-gradient-to-br from-orange-50 via-pink-50 to-purple-100',
          card: 'bg-gradient-to-br from-orange-100/80 to-pink-100/80',
          accent: 'bg-orange-500',
          text: 'text-orange-900',
          textLight: 'text-orange-700'
        }
      },
      ocean: {
        id: 'ocean',
        name: 'Ocean Adventure',
        fontFamily: "'Comfortaa', cursive",
        colors: {
          primary: 'from-blue-400 via-cyan-400 to-teal-500',
          bg: 'bg-gradient-to-br from-blue-50 via-cyan-50 to-teal-100',
          card: 'bg-gradient-to-br from-blue-100/80 to-cyan-100/80',
          accent: 'bg-blue-500',
          text: 'text-blue-900',
          textLight: 'text-blue-700'
        }
      },
      forest: {
        id: 'forest',
        name: 'Forest Friends',
        fontFamily: "'Kalam', cursive",
        colors: {
          primary: 'from-green-400 via-emerald-400 to-lime-500',
          bg: 'bg-gradient-to-br from-green-50 via-emerald-50 to-lime-100',
          card: 'bg-gradient-to-br from-green-100/80 to-emerald-100/80',
          accent: 'bg-green-600',
          text: 'text-green-900',
          textLight: 'text-green-700'
        }
      },
      mythical: {
        id: 'mythical',
        name: 'Mythical Magic',
        fontFamily: "'Comfortaa', cursive",
        colors: {
          primary: 'from-purple-400 via-pink-400 to-fuchsia-500',
          bg: 'bg-gradient-to-br from-purple-50 via-pink-50 to-fuchsia-100',
          card: 'bg-gradient-to-br from-purple-100/80 to-pink-100/80',
          accent: 'bg-purple-600',
          text: 'text-purple-900',
          textLight: 'text-purple-700'
        }
      },
      sky: {
        id: 'sky',
        name: 'Sky Dreams',
        fontFamily: "'Nunito', sans-serif",
        colors: {
          primary: 'from-sky-300 via-blue-300 to-indigo-400',
          bg: 'bg-gradient-to-br from-sky-50 via-blue-50 to-indigo-100',
          card: 'bg-gradient-to-br from-sky-100/80 to-blue-100/80',
          accent: 'bg-sky-500',
          text: 'text-sky-900',
          textLight: 'text-sky-700'
        }
      },
      stuffies: {
        id: 'stuffies',
        name: 'Stuffies Paradise',
        fontFamily: "'Comic Neue', cursive",
        colors: {
          primary: 'from-rose-300 via-pink-300 to-purple-300',
          bg: 'bg-gradient-to-br from-rose-50 via-pink-50 to-purple-50',
          card: 'bg-gradient-to-br from-rose-100/80 to-pink-100/80',
          accent: 'bg-rose-400',
          text: 'text-rose-900',
          textLight: 'text-rose-700'
        }
      },
      rainbow: {
        id: 'rainbow',
        name: 'Rainbow Fun',
        fontFamily: "'Fredoka One', cursive",
        colors: {
          primary: 'from-red-400 via-yellow-400 via-green-400 via-blue-400 to-purple-400',
          bg: 'bg-gradient-to-br from-red-50 via-yellow-50 via-green-50 via-blue-50 to-purple-50',
          card: 'bg-gradient-to-br from-yellow-100/80 to-pink-100/80',
          accent: 'bg-gradient-to-r from-red-500 to-purple-500',
          text: 'text-purple-900',
          textLight: 'text-indigo-700'
        }
      }
    };

    // Quest Templates
    const QUEST_TEMPLATES = {
      school: [
        { name: 'Homework', duration: 15, icon: 'üìê', badge: 'Math Master' },
        { name: 'Read for 20 Minutes', duration: 20, icon: 'üìö', badge: 'Reading Champion' },
        { name: 'Spelling Words', duration: 10, icon: '‚úèÔ∏è', badge: 'Spelling Star' },
        { name: 'Study for Quiz', duration: 20, icon: 'üìù', badge: 'Study Champion' },
        { name: 'Organize School Backpack', duration: 10, icon: 'üéí', badge: 'Organization Hero' }
      ],
      chore: [
        { name: 'Clean Your Room', duration: 30, icon: 'üßπ', badge: 'Tidy Master' },
        { name: 'Make Your Bed', duration: 5, icon: 'üõèÔ∏è', badge: 'Morning Hero' },
        { name: 'Water the Plants', duration: 5, icon: 'üå±', badge: 'Green Thumb' },
        { name: 'Organize Toys', duration: 30, icon: 'üß∏', badge: 'Organization Star' },
        { name: 'Dishwasher Load/Unload', duration: 15, icon: 'üç¥', badge: 'Kitchen Helper' },
        { name: 'Clean Bathroom', duration: 30, icon: 'üöø', badge: 'Cleaning Pro' },
        { name: 'Help with Laundry', duration: 20, icon: 'üëï', badge: 'Sorting Specialist' }
      ],
      routine: [
        { name: 'Bedtime Routine', duration: 15, icon: 'üåô', badge: 'Night Owl' },
        { name: 'Bathroom Routine', duration: 15, icon: 'üö∞', badge: 'Fresh & Clean' },
        { name: 'School Day Morning Routine', duration: 15, icon: '‚òÄÔ∏è', badge: 'Early Bird' }
      ]
    };

    const calculateStars = (duration) => {
      if (duration <= 10) return 1;
      if (duration <= 20) return 2;
      return 3;
    };

    const initialState = {
      quests: [],
      completedQuests: [],
      activeQuest: null,
      totalStars: 0,
      badges: [],
      rewards: [
        { id: 1, name: '30 Minutes Screen Time', cost: 10, icon: 'üì±' },
        { id: 2, name: 'Choose Dinner', cost: 10, icon: 'üçï' },
        { id: 3, name: 'Special Dessert', cost: 10, icon: 'üç∞' },
        { id: 4, name: 'Stay Up 30 Min Late', cost: 15, icon: 'üåü' },
        { id: 5, name: 'Pick Family Movie', cost: 10, icon: 'üé¨' },
        { id: 6, name: 'Indoor Swimming', cost: 20, icon: 'üèä' },
        { id: 7, name: 'Shopping Spree!', cost: 20, icon: 'üõçÔ∏è' }
      ],
      redeemedRewards: [],
      currentStreak: 0,
      longestStreak: 0,
      lastCompletedDate: null,
      transactionLog: []
    };

    function questReducer(state, action) {
      switch (action.type) {
        case 'LOAD_STATE':
          return { 
            ...state, 
            ...action.payload,
            totalStars: Math.max(0, action.payload.totalStars || 0),
            transactionLog: action.payload.transactionLog || []
          };
        
        case 'ADD_QUEST':
          return {
            ...state,
            quests: [...state.quests, { ...action.payload, id: Date.now() + Math.random() }]
          };
        
        case 'DELETE_QUEST':
          return {
            ...state,
            quests: state.quests.filter(q => q.id !== action.payload)
          };
        
        case 'START_QUEST':
          return {
            ...state,
            activeQuest: { 
              ...action.payload, 
              startTime: Date.now(),
              sessionId: `quest-${Date.now()}-${Math.random()}`
            }
          };
        
        case 'COMPLETE_QUEST': {
          const quest = action.payload;
          const stars = calculateStars(quest.duration);
          const today = new Date().toDateString();
          
          const alreadyCompleted = state.completedQuests.some(
            cq => cq.sessionId === quest.sessionId
          );
          
          if (alreadyCompleted) {
            return { ...state, activeQuest: null };
          }
          
          let newStreak = state.currentStreak;
          if (state.lastCompletedDate !== today) {
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            newStreak = state.lastCompletedDate === yesterday ? state.currentStreak + 1 : 1;
          }
          
          const badgeAlreadyEarned = state.badges.includes(quest.badge);
          const newBadges = badgeAlreadyEarned ? state.badges : [...state.badges, quest.badge];
          
          const transaction = {
            type: 'QUEST_COMPLETE',
            timestamp: Date.now(),
            questId: quest.id,
            questName: quest.name,
            starsAwarded: stars,
            badgeAwarded: !badgeAlreadyEarned ? quest.badge : null,
            sessionId: quest.sessionId
          };
          
          return {
            ...state,
            completedQuests: [...state.completedQuests, { 
              ...quest, 
              completedAt: Date.now(),
              starsAwarded: stars 
            }],
            totalStars: state.totalStars + stars,
            badges: newBadges,
            activeQuest: null,
            currentStreak: newStreak,
            longestStreak: Math.max(state.longestStreak, newStreak),
            lastCompletedDate: today,
            transactionLog: [...state.transactionLog, transaction]
          };
        }
        
        case 'CANCEL_QUEST':
          return { ...state, activeQuest: null };
        
        case 'REDEEM_REWARD': {
          const reward = action.payload;
          
          if (state.totalStars < reward.cost) {
            return state;
          }
          
          const recentRedemption = state.redeemedRewards.find(
            r => r.id === reward.id && (Date.now() - r.redeemedAt) < 1000
          );
          
          if (recentRedemption) {
            return state;
          }
          
          const redemptionId = `redeem-${Date.now()}-${Math.random()}`;
          
          const transaction = {
            type: 'REWARD_REDEEM',
            timestamp: Date.now(),
            rewardId: reward.id,
            rewardName: reward.name,
            starsCost: reward.cost,
            redemptionId: redemptionId
          };
          
          return {
            ...state,
            totalStars: Math.max(0, state.totalStars - reward.cost),
            redeemedRewards: [...state.redeemedRewards, { 
              ...reward, 
              redeemedAt: Date.now(),
              redemptionId: redemptionId
            }],
            transactionLog: [...state.transactionLog, transaction]
          };
        }
        
        case 'ADD_REWARD':
          return {
            ...state,
            rewards: [...state.rewards, { ...action.payload, id: Date.now() + Math.random() }]
          };
        
        case 'DELETE_REWARD':
          return {
            ...state,
            rewards: state.rewards.filter(r => r.id !== action.payload)
          };
        
        default:
          return state;
      }
    }

    const ThemeContext = createContext();

    // Emoji Picker Component
    function EmojiPicker({ onSelect, onClose }) {
      const { theme } = useContext(ThemeContext);
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedCategory, setSelectedCategory] = useState('all');

      const filteredEmojis = selectedCategory === 'all' 
        ? ALL_EMOJIS 
        : EMOJI_LIBRARY[selectedCategory] || [];

      const searchedEmojis = searchTerm
        ? filteredEmojis.filter(emoji => {
            const categories = Object.entries(EMOJI_LIBRARY).filter(([_, emojis]) => 
              emojis.includes(emoji)
            ).map(([cat, _]) => cat);
            return categories.some(cat => cat.toLowerCase().includes(searchTerm.toLowerCase()));
          })
        : filteredEmojis;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fadeIn">
          <div className={`${theme.colors.card} rounded-3xl p-6 max-w-md w-full shadow-2xl backdrop-blur-lg border-2 border-opacity-20 max-h-[90vh] overflow-y-auto`}>
            <div className="flex items-center justify-between mb-4">
              <h3 className={`text-xl font-bold ${theme.colors.text}`}>Choose an Icon</h3>
              <button onClick={onClose} className={`p-2 rounded-full ${theme.colors.textLight} hover:bg-white/30`}>
                <Icons.X className="w-5 h-5" />
              </button>
            </div>

            <div className="mb-4">
              <div className="relative">
                <Icons.Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 ${theme.colors.textLight}`} />
                <input
                  type="text"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  placeholder="Search emojis..."
                  className={`w-full pl-10 pr-4 py-3 rounded-xl bg-white/50 ${theme.colors.text} border-2 border-opacity-20 focus:outline-none focus:ring-2`}
                />
              </div>
            </div>

            <div className="mb-4 flex flex-wrap gap-2">
              <button
                onClick={() => setSelectedCategory('all')}
                className={`px-3 py-1 rounded-full text-sm font-semibold transition-all ${
                  selectedCategory === 'all' 
                    ? `${theme.colors.accent} text-white` 
                    : `bg-white/40 ${theme.colors.textLight}`
                }`}
              >
                All
              </button>
              {Object.keys(EMOJI_LIBRARY).map(category => (
                <button
                  key={category}
                  onClick={() => setSelectedCategory(category)}
                  className={`px-3 py-1 rounded-full text-sm font-semibold transition-all capitalize ${
                    selectedCategory === category 
                      ? `${theme.colors.accent} text-white` 
                      : `bg-white/40 ${theme.colors.textLight}`
                  }`}
                >
                  {category}
                </button>
              ))}
            </div>

            <div className="emoji-grid">
              {searchedEmojis.map((emoji, idx) => (
                <button
                  key={idx}
                  onClick={() => {
                    onSelect(emoji);
                    onClose();
                  }}
                  className="emoji-button"
                >
                  {emoji}
                </button>
              ))}
            </div>

            {searchedEmojis.length === 0 && (
              <p className={`text-center py-8 ${theme.colors.textLight}`}>
                No emojis found. Try a different search!
              </p>
            )}
          </div>
        </div>
      );
    }

    // Quest Card Component
    function QuestCard({ quest, onStart, onDelete }) {
      const { theme } = useContext(ThemeContext);
      const stars = calculateStars(quest.duration);

      return (
        <div className={`${theme.colors.card} rounded-3xl p-6 shadow-xl backdrop-blur-lg border-2 border-opacity-20 hover:scale-105 transition-all duration-200 group relative overflow-hidden`}>
          <div className={`absolute inset-0 bg-gradient-to-br ${theme.colors.primary} opacity-0 group-hover:opacity-10 transition-opacity duration-300`}></div>
          
          <div className="relative z-10">
            <div className="flex justify-between items-start mb-4">
              <div className="text-4xl">{quest.icon}</div>
              <button
                onClick={onDelete}
                className="p-2 rounded-full bg-red-500/20 hover:bg-red-500 text-red-600 hover:text-white transition-colors duration-200"
              >
                <Icons.X className="w-4 h-4" />
              </button>
            </div>

            <h3 className={`text-lg font-bold ${theme.colors.text} mb-2`}>
              {quest.name}
            </h3>

            <div className="flex items-center justify-between mb-4">
              <div className={`flex items-center space-x-1 ${theme.colors.textLight}`}>
                <Icons.Clock className="w-4 h-4" />
                <span className="text-sm font-semibold">{quest.duration} min</span>
              </div>
              <div className="flex items-center space-x-1">
                {[...Array(stars)].map((_, i) => (
                  <Icons.Star key={i} className="w-5 h-5 text-yellow-500 fill-yellow-500" />
                ))}
              </div>
            </div>

            <div className={`${theme.colors.textLight} text-xs mb-4 flex items-center`}>
              <Icons.Award className="w-4 h-4 mr-1" />
              <span>Badge: {quest.badge}</span>
            </div>

            <button
              onClick={onStart}
              className={`w-full ${theme.colors.accent} text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-200 flex items-center justify-center space-x-2 group-hover:scale-105`}
            >
              <Icons.Target className="w-5 h-5" />
              <span>Start Quest</span>
              <Icons.ChevronRight className="w-5 h-5" />
            </button>
          </div>
        </div>
      );
    }

    // Dashboard View
    function DashboardView({ quests, onStartQuest, onDeleteQuest, onAddQuest, questCategory, setQuestCategory }) {
      const { theme } = useContext(ThemeContext);
      
      const categories = [
        { id: 'school', label: 'School Quests', emoji: 'üìö' },
        { id: 'chore', label: 'Chore Quests', emoji: 'üè†' },
        { id: 'routine', label: 'Routine Quests', emoji: 'üåü' }
      ];

      const filteredQuests = quests.filter(q => q.category === questCategory);

      return (
        <div className="space-y-6">
          <div className={`${theme.colors.card} rounded-3xl p-4 shadow-2xl backdrop-blur-lg border-2 border-opacity-20`}>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
              {categories.map(cat => (
                <button
                  key={cat.id}
                  onClick={() => setQuestCategory(cat.id)}
                  className={`flex flex-col items-center justify-center p-4 rounded-2xl transition-all duration-200 ${
                    questCategory === cat.id
                      ? `${theme.colors.accent} text-white shadow-xl scale-105`
                      : `bg-white/40 ${theme.colors.textLight} hover:bg-white/60`
                  }`}
                >
                  <span className="text-3xl mb-2">{cat.emoji}</span>
                  <span className="font-bold text-sm sm:text-base">{cat.label}</span>
                </button>
              ))}
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {filteredQuests.map(quest => (
              <QuestCard
                key={quest.id}
                quest={quest}
                onStart={() => onStartQuest(quest)}
                onDelete={() => onDeleteQuest(quest.id)}
              />
            ))}
            
            <button
              onClick={onAddQuest}
              className={`${theme.colors.card} rounded-3xl p-6 shadow-xl backdrop-blur-lg border-2 border-dashed border-opacity-40 hover:scale-105 transition-all duration-200 flex flex-col items-center justify-center min-h-[200px] group`}
            >
              <div className={`w-16 h-16 rounded-full bg-gradient-to-br ${theme.colors.primary} flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-200`}>
                <Icons.Plus className="w-8 h-8 text-white" />
              </div>
              <span className={`text-lg font-bold ${theme.colors.text}`}>Add New Quest</span>
            </button>
          </div>
        </div>
      );
    }

    // Active Quest View
    function ActiveQuestView({ quest, onComplete, onCancel }) {
      const { theme } = useContext(ThemeContext);
      const [timeRemaining, setTimeRemaining] = useState(quest.duration * 60);
      const [isRunning, setIsRunning] = useState(false);
      const [isPaused, setIsPaused] = useState(false);
      const [showCelebration, setShowCelebration] = useState(false);
      const timerRef = useRef(null);

      const stars = calculateStars(quest.duration);
      const totalSeconds = quest.duration * 60;
      const progress = ((totalSeconds - timeRemaining) / totalSeconds) * 100;

      useEffect(() => {
        if (isRunning && !isPaused && timeRemaining > 0) {
          timerRef.current = setInterval(() => {
            setTimeRemaining(prev => {
              if (prev <= 1) {
                setIsRunning(false);
                setShowCelebration(true);
                setTimeout(() => onComplete(), 2000);
                return 0;
              }
              return prev - 1;
            });
          }, 1000);
        }

        return () => {
          if (timerRef.current) clearInterval(timerRef.current);
        };
      }, [isRunning, isPaused, timeRemaining, onComplete]);

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      };

      const handlePlayPause = () => {
        if (!isRunning) {
          setIsRunning(true);
          setIsPaused(false);
        } else {
          setIsPaused(!isPaused);
        }
      };

      const handleReset = () => {
        setTimeRemaining(quest.duration * 60);
        setIsRunning(false);
        setIsPaused(false);
      };

      return (
        <div className={`${theme.colors.card} rounded-3xl p-8 shadow-2xl backdrop-blur-lg border-2 border-opacity-20 relative overflow-hidden`}>
          {showCelebration && (
            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
              <div className="text-center animate-bounce">
                <div className="text-8xl mb-4">üéâ</div>
                <h2 className="text-4xl font-bold text-white mb-2">Quest Complete!</h2>
                <div className="flex items-center justify-center space-x-2">
                  {[...Array(stars)].map((_, i) => (
                    <Icons.Star key={i} className="w-12 h-12 text-yellow-400 fill-yellow-400 animate-spin" />
                  ))}
                </div>
                <p className="text-white text-xl mt-4">+{stars} Stars Earned!</p>
              </div>
            </div>
          )}

          <div className="w-full h-4 bg-white/30 rounded-full overflow-hidden mb-8">
            <div
              className={`h-full bg-gradient-to-r ${theme.colors.primary} transition-all duration-1000 ease-linear`}
              style={{ width: `${progress}%` }}
            ></div>
          </div>

          <div className="text-center">
            <div className="text-8xl mb-6 animate-bounce">{quest.icon}</div>
            
            <h2 className={`text-3xl sm:text-4xl font-bold ${theme.colors.text} mb-4`}>
              {quest.name}
            </h2>

            <div className="flex items-center justify-center space-x-2 mb-8">
              {[...Array(stars)].map((_, i) => (
                <Icons.Star key={i} className="w-8 h-8 text-yellow-500 fill-yellow-500" />
              ))}
            </div>

            <div className={`text-8xl sm:text-9xl font-bold ${theme.colors.text} mb-8 font-mono`}>
              {formatTime(timeRemaining)}
            </div>

            <div className="flex items-center justify-center space-x-4 mb-6">
              <button
                onClick={handlePlayPause}
                className={`p-6 ${theme.colors.accent} text-white rounded-full shadow-2xl hover:scale-110 transition-all duration-200`}
              >
                {isRunning && !isPaused ? (
                  <Icons.Pause className="w-8 h-8" />
                ) : (
                  <Icons.Play className="w-8 h-8" />
                )}
              </button>
              
              <button
                onClick={handleReset}
                className={`p-6 ${theme.colors.card} ${theme.colors.text} rounded-full shadow-xl hover:scale-110 transition-all duration-200 border-2 border-opacity-30`}
              >
                <Icons.RotateCcw className="w-8 h-8" />
              </button>
            </div>

            <button
              onClick={onCancel}
              className={`px-8 py-3 bg-gray-400 text-white rounded-xl font-bold hover:bg-gray-500 transition-colors duration-200`}
            >
              Cancel Quest
            </button>

            <div className={`mt-8 ${theme.colors.textLight} text-sm`}>
              <p>Stay focused and complete your quest to earn stars and badges! üåü</p>
            </div>
          </div>
        </div>
      );
    }

    // Rewards View
    function RewardsView({ rewards, totalStars, redeemedRewards, onRedeemReward, onAddReward, onDeleteReward }) {
      const { theme } = useContext(ThemeContext);
      const [isRedeeming, setIsRedeeming] = useState(null);

      const handleRedeem = async (reward) => {
        if (isRedeeming || totalStars < reward.cost) return;
        
        setIsRedeeming(reward.id);
        
        setTimeout(() => {
          onRedeemReward(reward);
          setIsRedeeming(null);
        }, 300);
      };

      return (
        <div className="space-y-6">
          <div className={`${theme.colors.card} rounded-3xl p-6 shadow-2xl backdrop-blur-lg border-2 border-opacity-20`}>
            <div className="flex items-center justify-between mb-4">
              <h2 className={`text-2xl font-bold ${theme.colors.text} flex items-center`}>
                <Icons.Gift className="w-7 h-7 mr-3" />
                Rewards Shop
              </h2>
              <div className={`flex items-center space-x-2 ${theme.colors.accent} text-white px-6 py-3 rounded-full shadow-lg`}>
                <Icons.Star className="w-6 h-6 fill-white" />
                <span className="text-2xl font-bold">{totalStars}</span>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {rewards.map(reward => (
              <div
                key={reward.id}
                className={`${theme.colors.card} rounded-3xl p-6 shadow-xl backdrop-blur-lg border-2 border-opacity-20 hover:scale-105 transition-all duration-200 relative group`}
              >
                <button
                  onClick={() => onDeleteReward(reward.id)}
                  className="absolute top-4 right-4 p-2 rounded-full bg-red-500/20 hover:bg-red-500 text-red-600 hover:text-white transition-colors duration-200 opacity-0 group-hover:opacity-100"
                >
                  <Icons.X className="w-4 h-4" />
                </button>

                <div className="text-6xl mb-4 text-center">{reward.icon}</div>
                <h3 className={`text-lg font-bold ${theme.colors.text} mb-3 text-center`}>
                  {reward.name}
                </h3>
                
                <div className="flex items-center justify-center space-x-2 mb-4">
                  <Icons.Star className="w-5 h-5 text-yellow-500 fill-yellow-500" />
                  <span className={`text-xl font-bold ${theme.colors.text}`}>{reward.cost}</span>
                </div>

                <button
                  onClick={() => handleRedeem(reward)}
                  disabled={totalStars < reward.cost || isRedeeming === reward.id}
                  className={`w-full py-3 rounded-xl font-bold transition-all duration-200 ${
                    totalStars >= reward.cost && isRedeeming !== reward.id
                      ? `${theme.colors.accent} text-white hover:shadow-lg hover:scale-105`
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  {isRedeeming === reward.id ? 'Redeeming...' : totalStars >= reward.cost ? 'Redeem' : 'Not Enough Stars'}
                </button>
              </div>
            ))}

            <button
              onClick={onAddReward}
              className={`${theme.colors.card} rounded-3xl p-6 shadow-xl backdrop-blur-lg border-2 border-dashed border-opacity-40 hover:scale-105 transition-all duration-200 flex flex-col items-center justify-center min-h-[250px] group`}
            >
              <div className={`w-16 h-16 rounded-full bg-gradient-to-br ${theme.colors.primary} flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-200`}>
                <Icons.Plus className="w-8 h-8 text-white" />
              </div>
              <span className={`text-lg font-bold ${theme.colors.text}`}>Add Custom Reward</span>
            </button>
          </div>

          {redeemedRewards.length > 0 && (
            <div className={`${theme.colors.card} rounded-3xl p-6 shadow-2xl backdrop-blur-lg border-2 border-opacity-20`}>
              <h3 className={`text-xl font-bold ${theme.colors.text} mb-4 flex items-center`}>
                <Icons.Check className="w-6 h-6 mr-2" />
                Recently Redeemed
              </h3>
              <div className="space-y-2">
                {redeemedRewards.slice(-5).reverse().map((reward, idx) => (
                  <div key={idx} className="flex items-center justify-between p-3 bg-white/40 rounded-xl">
                    <div className="flex items-center space-x-3">
                      <span className="text-2xl">{reward.icon}</span>
                      <div>
                        <span className={`font-semibold ${theme.colors.text} block`}>{reward.name}</span>
                        <span className={`text-xs ${theme.colors.textLight}`}>
                          {reward.cost} stars redeemed
                        </span>
                      </div>
                    </div>
                    <span className={`text-sm ${theme.colors.textLight}`}>
                      {new Date(reward.redeemedAt).toLocaleDateString()}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    // Achievements View
    function AchievementsView({ badges, completedQuests, currentStreak, longestStreak }) {
      const { theme } = useContext(ThemeContext);

      const categoryStats = {
        school: completedQuests.filter(q => q.category === 'school').length,
        chore: completedQuests.filter(q => q.category === 'chore').length,
        routine: completedQuests.filter(q => q.category === 'routine').length
      };

      return (
        <div className="space-y-6">
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className={`${theme.colors.card} rounded-3xl p-6 shadow-xl backdrop-blur-lg border-2 border-opacity-20`}>
              <div className="flex items-center justify-between">
                <div>
                  <p className={`text-sm ${theme.colors.textLight} mb-1`}>Total Quests</p>
                  <p className={`text-3xl font-bold ${theme.colors.text}`}>{completedQuests.length}</p>
                </div>
                <Icons.Trophy className={`w-12 h-12 ${theme.colors.textLight}`} />
              </div>
            </div>

            <div className={`${theme.colors.card} rounded-3xl p-6 shadow-xl backdrop-blur-lg border-2 border-opacity-20`}>
              <div className="flex items-center justify-between">
                <div>
                  <p className={`text-sm ${theme.colors.textLight} mb-1`}>Badges Earned</p>
                  <p className={`text-3xl font-bold ${theme.colors.text}`}>{badges.length}</p>
                </div>
                <Icons.Award className={`w-12 h-12 ${theme.colors.textLight}`} />
              </div>
            </div>

            <div className={`${theme.colors.card} rounded-3xl p-6 shadow-xl backdrop-blur-lg border-2 border-opacity-20`}>
              <div className="flex items-center justify-between">
                <div>
                  <p className={`text-sm ${theme.colors.textLight} mb-1`}>Current Streak</p>
                  <p className={`text-3xl font-bold ${theme.colors.text}`}>{currentStreak} üî•</p>
                </div>
                <Icons.Zap className={`w-12 h-12 ${theme.colors.textLight}`} />
              </div>
            </div>

            <div className={`${theme.colors.card} rounded-3xl p-6 shadow-xl backdrop-blur-lg border-2 border-opacity-20`}>
              <div className="flex items-center justify-between">
                <div>
                  <p className={`text-sm ${theme.colors.textLight} mb-1`}>Best Streak</p>
                  <p className={`text-3xl font-bold ${theme.colors.text}`}>{longestStreak} üèÜ</p>
                </div>
                <Icons.Crown className={`w-12 h-12 ${theme.colors.textLight}`} />
              </div>
            </div>
          </div>

          <div className={`${theme.colors.card} rounded-3xl p-6 shadow-2xl backdrop-blur-lg border-2 border-opacity-20`}>
            <h2 className={`text-2xl font-bold ${theme.colors.text} mb-6 flex items-center`}>
              <Icons.Target className="w-7 h-7 mr-3" />
              Quest Progress by Category
            </h2>
            <div className="space-y-4">
              {[
                { id: 'school', label: 'School Quests', emoji: 'üìö', count: categoryStats.school },
                { id: 'chore', label: 'Chore Quests', emoji: 'üè†', count: categoryStats.chore },
                { id: 'routine', label: 'Routine Quests', emoji: 'üåü', count: categoryStats.routine }
              ].map(cat => (
                <div key={cat.id} className="flex items-center space-x-4">
                  <span className="text-3xl">{cat.emoji}</span>
                  <div className="flex-1">
                    <div className="flex justify-between mb-2">
                      <span className={`font-semibold ${theme.colors.text}`}>{cat.label}</span>
                      <span className={`font-bold ${theme.colors.text}`}>{cat.count} completed</span>
                    </div>
                    <div className="w-full h-3 bg-white/30 rounded-full overflow-hidden">
                      <div
                        className={`h-full bg-gradient-to-r ${theme.colors.primary} transition-all duration-500`}
                        style={{ width: `${Math.min((cat.count / completedQuests.length) * 100 || 0, 100)}%` }}
                      ></div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className={`${theme.colors.card} rounded-3xl p-6 shadow-2xl backdrop-blur-lg border-2 border-opacity-20`}>
            <h2 className={`text-2xl font-bold ${theme.colors.text} mb-6 flex items-center`}>
              <Icons.Award className="w-7 h-7 mr-3" />
              Badge Collection ({badges.length})
            </h2>
            {badges.length > 0 ? (
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                {badges.map((badge, idx) => (
                  <div
                    key={idx}
                    className={`p-4 bg-white/40 rounded-2xl text-center hover:scale-110 transition-transform duration-200 border-2 border-opacity-20`}
                  >
                    <div className="text-3xl mb-2">üèÖ</div>
                    <p className={`text-sm font-bold ${theme.colors.text}`}>{badge}</p>
                  </div>
                ))}
              </div>
            ) : (
              <p className={`text-center ${theme.colors.textLight} py-8`}>
                Complete quests to earn your first badge! üåü
              </p>
            )}
          </div>
        </div>
      );
    }

    // Settings Modal
    function SettingsModal({ onClose }) {
      const { theme, currentTheme, setCurrentTheme } = useContext(ThemeContext);

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fadeIn">
          <div className={`${theme.colors.card} rounded-3xl p-6 sm:p-8 max-w-2xl w-full shadow-2xl backdrop-blur-lg border-2 border-opacity-20 max-h-[90vh] overflow-y-auto`}>
            <div className="flex items-center justify-between mb-6">
              <h2 className={`text-2xl sm:text-3xl font-bold ${theme.colors.text} flex items-center`}>
                <Icons.Settings className="w-7 h-7 mr-3" />
                Settings
              </h2>
              <button
                onClick={onClose}
                className={`p-2 rounded-full ${theme.colors.textLight} hover:bg-white/30 transition-colors duration-200`}
              >
                <Icons.X className="w-6 h-6" />
              </button>
            </div>

            <div className="space-y-6">
              <div>
                <h3 className={`text-lg font-bold ${theme.colors.text} mb-4`}>Choose Your Theme</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  {Object.entries(THEMES).map(([key, themeOption]) => (
                    <button
                      key={key}
                      onClick={() => setCurrentTheme(key)}
                      className={`p-4 rounded-2xl border-2 transition-all duration-200 text-left ${
                        currentTheme === key
                          ? 'border-current scale-105 shadow-xl'
                          : 'border-transparent hover:scale-105'
                      }`}
                      style={{
                        background: themeOption.colors.bg,
                        fontFamily: themeOption.fontFamily
                      }}
                    >
                      <div className={`font-bold text-lg mb-1`} style={{ color: themeOption.colors.text }}>
                        {themeOption.name}
                      </div>
                      <div className={`text-sm`} style={{ color: themeOption.colors.textLight }}>
                        {currentTheme === key && '‚úì Active'}
                      </div>
                    </button>
                  ))}
                </div>
              </div>

              <div className={`p-4 bg-white/40 rounded-2xl ${theme.colors.textLight}`}>
                <p className="text-sm">
                  üí° <strong>Tip:</strong> Each theme has its own unique look and feel! Try them all to find your favorite adventure style.
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Add Quest Modal
    function AddQuestModal({ category, onClose, onAdd }) {
      const { theme } = useContext(ThemeContext);
      const [name, setName] = useState('');
      const [duration, setDuration] = useState(20);
      const [icon, setIcon] = useState('‚≠ê');
      const [badge, setBadge] = useState('');
      const [showEmojiPicker, setShowEmojiPicker] = useState(false);

      const handleSubmit = (e) => {
        e.preventDefault();
        if (name && badge) {
          onAdd({ name, duration: Math.min(duration, 30), icon, badge, category });
        }
      };

      return (
        <>
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fadeIn">
            <div className={`${theme.colors.card} rounded-3xl p-6 sm:p-8 max-w-md w-full shadow-2xl backdrop-blur-lg border-2 border-opacity-20`}>
              <div className="flex items-center justify-between mb-6">
                <h2 className={`text-2xl font-bold ${theme.colors.text}`}>Add New Quest</h2>
                <button onClick={onClose} className={`p-2 rounded-full ${theme.colors.textLight} hover:bg-white/30`}>
                  <Icons.X className="w-6 h-6" />
                </button>
              </div>

              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className={`block text-sm font-bold ${theme.colors.text} mb-2`}>Quest Name</label>
                  <input
                    type="text"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    className={`w-full px-4 py-3 rounded-xl bg-white/50 ${theme.colors.text} border-2 border-opacity-20 focus:outline-none focus:ring-2 focus:ring-opacity-50`}
                    placeholder="Enter quest name"
                    required
                  />
                </div>

                <div>
                  <label className={`block text-sm font-bold ${theme.colors.text} mb-2`}>
                    Duration (minutes): {Math.min(duration, 30)} {duration > 30 && <span className="text-red-500">(Max: 30)</span>}
                  </label>
                  <input
                    type="range"
                    min="5"
                    max="30"
                    step="5"
                    value={Math.min(duration, 30)}
                    onChange={(e) => setDuration(Number(e.target.value))}
                    className="w-full"
                  />
                  <div className="flex justify-start space-x-1 mt-1">
                    {[...Array(calculateStars(Math.min(duration, 30)))].map((_, i) => (
                      <Icons.Star key={i} className="w-4 h-4 text-yellow-500 fill-yellow-500" />
                    ))}
                    <span className={`text-xs ${theme.colors.textLight} ml-2`}>
                      {calculateStars(Math.min(duration, 30))} {calculateStars(Math.min(duration, 30)) === 1 ? 'star' : 'stars'}
                    </span>
                  </div>
                </div>

                <div>
                  <label className={`block text-sm font-bold ${theme.colors.text} mb-2`}>Icon (emoji)</label>
                  <div className="flex space-x-2">
                    <input
                      type="text"
                      value={icon}
                      onChange={(e) => setIcon(e.target.value)}
                      className={`flex-1 px-4 py-3 rounded-xl bg-white/50 ${theme.colors.text} border-2 border-opacity-20 focus:outline-none focus:ring-2 focus:ring-opacity-50 text-2xl text-center`}
                      placeholder="‚≠ê"
                      maxLength="2"
                      required
                    />
                    <button
                      type="button"
                      onClick={() => setShowEmojiPicker(true)}
                      className={`px-4 py-3 ${theme.colors.accent} text-white rounded-xl font-bold hover:shadow-lg transition-all duration-200`}
                    >
                      Browse
                    </button>
                  </div>
                </div>

                <div>
                  <label className={`block text-sm font-bold ${theme.colors.text} mb-2`}>Badge Name</label>
                  <input
                    type="text"
                    value={badge}
                    onChange={(e) => setBadge(e.target.value)}
                    className={`w-full px-4 py-3 rounded-xl bg-white/50 ${theme.colors.text} border-2 border-opacity-20 focus:outline-none focus:ring-2 focus:ring-opacity-50`}
                    placeholder="Enter badge name"
                    required
                  />
                </div>

                <button
                  type="submit"
                  className={`w-full ${theme.colors.accent} text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-200`}
                >
                  Create Quest
                </button>
              </form>
            </div>
          </div>

          {showEmojiPicker && (
            <EmojiPicker
              onSelect={(emoji) => setIcon(emoji)}
              onClose={() => setShowEmojiPicker(false)}
            />
          )}
        </>
      );
    }

    // Add Reward Modal
    function AddRewardModal({ onClose, onAdd }) {
      const { theme } = useContext(ThemeContext);
      const [name, setName] = useState('');
      const [cost, setCost] = useState(10);
      const [icon, setIcon] = useState('üéÅ');
      const [showEmojiPicker, setShowEmojiPicker] = useState(false);

      const handleSubmit = (e) => {
        e.preventDefault();
        if (name) {
          onAdd({ name, cost, icon });
        }
      };

      return (
        <>
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fadeIn">
            <div className={`${theme.colors.card} rounded-3xl p-6 sm:p-8 max-w-md w-full shadow-2xl backdrop-blur-lg border-2 border-opacity-20`}>
              <div className="flex items-center justify-between mb-6">
                <h2 className={`text-2xl font-bold ${theme.colors.text}`}>Add Custom Reward</h2>
                <button onClick={onClose} className={`p-2 rounded-full ${theme.colors.textLight} hover:bg-white/30`}>
                  <Icons.X className="w-6 h-6" />
                </button>
              </div>

              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className={`block text-sm font-bold ${theme.colors.text} mb-2`}>Reward Name</label>
                  <input
                    type="text"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    className={`w-full px-4 py-3 rounded-xl bg-white/50 ${theme.colors.text} border-2 border-opacity-20 focus:outline-none focus:ring-2 focus:ring-opacity-50`}
                    placeholder="Enter reward name"
                    required
                  />
                </div>

                <div>
                  <label className={`block text-sm font-bold ${theme.colors.text} mb-2`}>
                    Star Cost: {cost}
                  </label>
                  <input
                    type="range"
                    min="1"
                    max="30"
                    value={cost}
                    onChange={(e) => setCost(Number(e.target.value))}
                    className="w-full"
                  />
                  <div className="flex items-center justify-center space-x-1 mt-2">
                    <Icons.Star className="w-5 h-5 text-yellow-500 fill-yellow-500" />
                    <span className={`text-lg font-bold ${theme.colors.text}`}>{cost}</span>
                  </div>
                </div>

                <div>
                  <label className={`block text-sm font-bold ${theme.colors.text} mb-2`}>Icon (emoji)</label>
                  <div className="flex space-x-2">
                    <input
                      type="text"
                      value={icon}
                      onChange={(e) => setIcon(e.target.value)}
                      className={`flex-1 px-4 py-3 rounded-xl bg-white/50 ${theme.colors.text} border-2 border-opacity-20 focus:outline-none focus:ring-2 focus:ring-opacity-50 text-2xl text-center`}
                      placeholder="üéÅ"
                      maxLength="2"
                      required
                    />
                    <button
                      type="button"
                      onClick={() => setShowEmojiPicker(true)}
                      className={`px-4 py-3 ${theme.colors.accent} text-white rounded-xl font-bold hover:shadow-lg transition-all duration-200`}
                    >
                      Browse
                    </button>
                  </div>
                </div>

                <button
                  type="submit"
                  className={`w-full ${theme.colors.accent} text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all duration-200`}
                >
                  Create Reward
                </button>
              </form>
            </div>
          </div>

          {showEmojiPicker && (
            <EmojiPicker
              onSelect={(emoji) => setIcon(emoji)}
              onClose={() => setShowEmojiPicker(false)}
            />
          )}
        </>
      );
    }

    // Main App
    function ClairesChoreQuest() {
      const [state, dispatch] = useReducer(questReducer, initialState);
      const [currentTheme, setCurrentTheme] = useState('space');
      const [currentView, setCurrentView] = useState('dashboard');
      const [showSettings, setShowSettings] = useState(false);
      const [showAddQuest, setShowAddQuest] = useState(false);
      const [showAddReward, setShowAddReward] = useState(false);
      const [questCategory, setQuestCategory] = useState('school');
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

      const theme = THEMES[currentTheme];

      useEffect(() => {
        const saved = localStorage.getItem('clairesChoreQuest');
        if (saved) {
          try {
            const parsedState = JSON.parse(saved);
            if (parsedState.totalStars < 0) {
              parsedState.totalStars = 0;
            }
            dispatch({ type: 'LOAD_STATE', payload: parsedState });
          } catch (e) {
            console.error('Failed to load saved state:', e);
          }
        }
        
        const savedTheme = localStorage.getItem('questTheme');
        if (savedTheme && THEMES[savedTheme]) {
          setCurrentTheme(savedTheme);
        }
      }, []);

      useEffect(() => {
        const timeoutId = setTimeout(() => {
          try {
            localStorage.setItem('clairesChoreQuest', JSON.stringify(state));
          } catch (e) {
            console.error('Failed to save state:', e);
          }
        }, 500);
        
        return () => clearTimeout(timeoutId);
      }, [state]);

      useEffect(() => {
        localStorage.setItem('questTheme', currentTheme);
      }, [currentTheme]);

      useEffect(() => {
        if (state.quests.length === 0) {
          Object.entries(QUEST_TEMPLATES).forEach(([category, quests]) => {
            quests.forEach(quest => {
              dispatch({
                type: 'ADD_QUEST',
                payload: { ...quest, category }
              });
            });
          });
        }
      }, [state.quests.length]);

      return (
        <ThemeContext.Provider value={{ theme, currentTheme, setCurrentTheme }}>
          <div className={`min-h-screen ${theme.colors.bg} transition-all duration-500`} style={{ fontFamily: theme.fontFamily }}>
            <header className={`${theme.colors.card} backdrop-blur-lg shadow-2xl border-b-4 border-opacity-30`}>
              <div className="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <div className={`w-12 h-12 rounded-full bg-gradient-to-br ${theme.colors.primary} flex items-center justify-center shadow-lg animate-pulse`}>
                      <Icons.Sparkles className="w-6 h-6 text-white" />
                    </div>
                    <div>
                      <h1 className={`text-2xl sm:text-3xl font-bold ${theme.colors.text}`}>
                        Claire's Chore Quest
                      </h1>
                      <p className={`text-xs sm:text-sm ${theme.colors.textLight}`}>
                        {theme.name}
                      </p>
                    </div>
                  </div>
                  
                  <div className="flex items-center space-x-2 sm:space-x-4">
                    <div className={`hidden sm:flex items-center space-x-2 ${theme.colors.card} px-4 py-2 rounded-full shadow-lg border-2 border-opacity-20`}>
                      <Icons.Star className="w-5 h-5 text-yellow-500 fill-yellow-500" />
                      <span className={`text-xl font-bold ${theme.colors.text}`}>{state.totalStars}</span>
                    </div>
                    <button
                      onClick={() => setShowSettings(true)}
                      className={`p-2 sm:p-3 ${theme.colors.card} rounded-full shadow-lg hover:scale-110 transition-transform duration-200`}
                    >
                      <Icons.Settings className={`w-5 h-5 ${theme.colors.text}`} />
                    </button>
                    <button
                      onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                      className={`p-2 sm:p-3 ${theme.colors.card} rounded-full shadow-lg hover:scale-110 transition-transform duration-200 md:hidden`}
                    >
                      <Icons.Menu className={`w-5 h-5 ${theme.colors.text}`} />
                    </button>
                  </div>
                </div>
                
                <div className={`sm:hidden flex items-center justify-center mt-4 ${theme.colors.card} px-4 py-2 rounded-full shadow-lg border-2 border-opacity-20`}>
                  <Icons.Star className="w-5 h-5 text-yellow-500 fill-yellow-500 mr-2" />
                  <span className={`text-xl font-bold ${theme.colors.text}`}>{state.totalStars} Stars</span>
                </div>
              </div>
            </header>

            {isMobileMenuOpen && (
              <div className={`md:hidden ${theme.colors.card} backdrop-blur-lg shadow-xl border-b-2 border-opacity-30 animate-slideDown`}>
                <nav className="px-4 py-2 space-y-1">
                  {[
                    { id: 'dashboard', label: 'Dashboard', icon: Icons.Home },
                    { id: 'rewards', label: 'Rewards', icon: Icons.Gift },
                    { id: 'achievements', label: 'Achievements', icon: Icons.Trophy }
                  ].map(item => (
                    <button
                      key={item.id}
                      onClick={() => {
                        setCurrentView(item.id);
                        setIsMobileMenuOpen(false);
                      }}
                      className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 ${
                        currentView === item.id
                          ? `${theme.colors.accent} text-white shadow-lg scale-105`
                          : `${theme.colors.textLight} hover:bg-white/30`
                      }`}
                    >
                      <item.icon className="w-5 h-5" />
                      <span className="font-semibold">{item.label}</span>
                    </button>
                  ))}
                </nav>
              </div>
            )}

            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              <div className="flex flex-col md:flex-row gap-6">
                <aside className="hidden md:block w-64 space-y-4">
                  <nav className={`${theme.colors.card} rounded-3xl p-4 shadow-2xl backdrop-blur-lg border-2 border-opacity-20`}>
                    <h2 className={`text-lg font-bold ${theme.colors.text} mb-4 px-2`}>Navigation</h2>
                    <div className="space-y-2">
                      {[
                        { id: 'dashboard', label: 'Dashboard', icon: Icons.Home },
                        { id: 'rewards', label: 'Rewards Shop', icon: Icons.Gift },
                        { id: 'achievements', label: 'Achievements', icon: Icons.Trophy }
                      ].map(item => (
                        <button
                          key={item.id}
                          onClick={() => setCurrentView(item.id)}
                          className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 ${
                            currentView === item.id
                              ? `${theme.colors.accent} text-white shadow-lg scale-105`
                              : `${theme.colors.textLight} hover:bg-white/30`
                          }`}
                        >
                          <item.icon className="w-5 h-5" />
                          <span className="font-semibold">{item.label}</span>
                        </button>
                      ))}
                    </div>
                  </nav>

                  <div className={`${theme.colors.card} rounded-3xl p-6 shadow-2xl backdrop-blur-lg border-2 border-opacity-20`}>
                    <h3 className={`text-lg font-bold ${theme.colors.text} mb-4 flex items-center`}>
                      <Icons.Zap className="w-5 h-5 mr-2" />
                      Quick Stats
                    </h3>
                    <div className="space-y-3">
                      <div className="flex justify-between items-center">
                        <span className={theme.colors.textLight}>Total Quests</span>
                        <span className={`font-bold ${theme.colors.text}`}>{state.completedQuests.length}</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className={theme.colors.textLight}>Badges</span>
                        <span className={`font-bold ${theme.colors.text}`}>{state.badges.length}</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className={theme.colors.textLight}>Current Streak</span>
                        <span className={`font-bold ${theme.colors.text}`}>{state.currentStreak} üî•</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className={theme.colors.textLight}>Best Streak</span>
                        <span className={`font-bold ${theme.colors.text}`}>{state.longestStreak} üèÜ</span>
                      </div>
                    </div>
                  </div>
                </aside>

                <main className="flex-1">
                  {state.activeQuest ? (
                    <ActiveQuestView
                      quest={state.activeQuest}
                      onComplete={() => dispatch({ type: 'COMPLETE_QUEST', payload: state.activeQuest })}
                      onCancel={() => dispatch({ type: 'CANCEL_QUEST' })}
                    />
                  ) : currentView === 'dashboard' ? (
                    <DashboardView
                      quests={state.quests}
                      onStartQuest={(quest) => dispatch({ type: 'START_QUEST', payload: quest })}
                      onDeleteQuest={(id) => dispatch({ type: 'DELETE_QUEST', payload: id })}
                      onAddQuest={() => setShowAddQuest(true)}
                      questCategory={questCategory}
                      setQuestCategory={setQuestCategory}
                    />
                  ) : currentView === 'rewards' ? (
                    <RewardsView
                      rewards={state.rewards}
                      totalStars={state.totalStars}
                      redeemedRewards={state.redeemedRewards}
                      onRedeemReward={(reward) => dispatch({ type: 'REDEEM_REWARD', payload: reward })}
                      onAddReward={() => setShowAddReward(true)}
                      onDeleteReward={(id) => dispatch({ type: 'DELETE_REWARD', payload: id })}
                    />
                  ) : (
                    <AchievementsView
                      badges={state.badges}
                      completedQuests={state.completedQuests}
                      currentStreak={state.currentStreak}
                      longestStreak={state.longestStreak}
                    />
                  )}
                </main>
              </div>
            </div>

            {showSettings && (
              <SettingsModal onClose={() => setShowSettings(false)} />
            )}
            {showAddQuest && (
              <AddQuestModal
                category={questCategory}
                onClose={() => setShowAddQuest(false)}
                onAdd={(quest) => {
                  dispatch({ type: 'ADD_QUEST', payload: quest });
                  setShowAddQuest(false);
                }}
              />
            )}
            {showAddReward && (
              <AddRewardModal
                onClose={() => setShowAddReward(false)}
                onAdd={(reward) => {
                  dispatch({ type: 'ADD_REWARD', payload: reward });
                  setShowAddReward(false);
                }}
              />
            )}
          </div>
        </ThemeContext.Provider>
      );
    }

    ReactDOM.render(<ClairesChoreQuest />, document.getElementById('root'));
  </script>
</body>
</html>
